name: CN-Web Deployment Pipeline (Infra + ECR + Deploy + Trivy + Sonar)

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 323001028681
  ECR_REPO: cn-web
  IMAGE_TAG: ${{ github.sha }}

jobs:
# ===============================
# STAGE 1: INFRA PROVISIONING
# ===============================
  infra:
    name: Infra Provisioning (Terraform)
    runs-on: ubuntu-latest

    outputs:
      ec2_ip: ${{ steps.ip.outputs.EC2_IP }}

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::323001028681:role/saransh-oidc
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.3

      - run: terraform init
        working-directory: infra

      - run: terraform apply -auto-approve
        working-directory: infra

      - id: ip
        working-directory: infra
        run: |
          echo "EC2_IP=$(terraform output -raw ec2_public_ip)" >> $GITHUB_OUTPUT

# ===============================
# STAGE 1.5: FRONTEND TESTS + COVERAGE + SONAR
# ===============================
  frontend_unit_tests_sonar:
    name: Frontend Unit Tests + Coverage + SonarQube
    runs-on: ubuntu-latest
    needs: infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare artifact directories
        run: |
          mkdir -p frontend/coverage frontend/reports
          touch frontend/reports/junit.xml

      - name: Run frontend unit tests inside Docker
        run: |
          docker run --rm \
            -v "${{ github.workspace }}/frontend:/app" \
            -w /app \
            node:18 \
            sh -c "
              npm install &&
              npm run test:ci || true
            "

      - name: Verify coverage output
        run: |
          ls -l frontend/coverage || true
          head -20 frontend/coverage/lcov.info || true

      # ---------------- SONARQUBE SCAN (FIXED FOR COVERAGE) ----------------
      - name: SonarQube Scan (with Coverage)
        uses: sonarsource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=cn-web
            -Dsonar.projectName=CN-Web
            -Dsonar.projectBaseDir=frontend
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.test.inclusions=src/**/*.test.ts,src/**/*.test.tsx
            -Dsonar.exclusions=**/node_modules/**,**/dist/**
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

      # ---------------- ARTIFACTS ----------------
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/

      - name: Upload test reports artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-reports
          path: frontend/reports/

# ===============================
# STAGE 2: BUILD + TRIVY + PUSH
# ===============================
  build_push:
    name: Build, Scan & Push Image to ECR
    runs-on: ubuntu-latest
    needs: frontend_unit_tests_sonar

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::323001028681:role/saransh-oidc
          aws-region: ${{ env.AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker Image
        run: |
          docker build \
            -t $ECR_REPO:${IMAGE_TAG} \
            -f frontend/Dockerfile \
            frontend

      - name: Trivy Image Scan
        run: |
          mkdir -p trivy-reports
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v $(pwd)/trivy-reports:/reports \
            aquasec/trivy:latest \
            image \
            --severity HIGH,CRITICAL \
            --format json \
            --output /reports/trivy-image-report.json \
            $ECR_REPO:${IMAGE_TAG}

      - uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: trivy-reports/trivy-image-report.json

      - name: Tag & Push Image
        run: |
          docker tag $ECR_REPO:${IMAGE_TAG} \
            $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:${IMAGE_TAG}

          docker push \
            $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:${IMAGE_TAG}

# ===============================
# STAGE 3: DEPLOY USING SSH
# âŒ NOT TOUCHED (AS REQUESTED)
# ===============================
  deploy:
    name: Deploy on EC2 using SSH
    runs-on: ubuntu-latest
    needs: [infra, build_push]

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_SARANSH }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.infra.outputs.ec2_ip }} >> ~/.ssh/known_hosts

      - name: Deploy Docker Container on EC2
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ needs.infra.outputs.ec2_ip }} << EOF
          sudo apt-get update -y
          sudo apt-get install -y docker.io amazon-ecr-credential-helper

          sudo mkdir -p /root/.docker
          echo '{
            "credHelpers": {
              "323001028681.dkr.ecr.us-east-1.amazonaws.com": "ecr-login"
            }
          }' | sudo tee /root/.docker/config.json > /dev/null

          sudo systemctl restart docker

          sudo docker pull 323001028681.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_TAG}

          sudo docker rm -f cn-web-container || true

          sudo docker run -d \
            --name cn-web-container \
            -p 5173:5173 \
            323001028681.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_TAG}
          EOF
