name: CN-Web Deployment Pipeline (Infra + ECR + Deploy + Trivy)

# on:
#   workflow_dispatch:   # manual trigger

# hello everyone

on:
  push:
    branches:
      - main 

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 323001028681
  ECR_REPO: cn-web
  IMAGE_TAG: ${{ github.sha }}

jobs:
# ===============================
# STAGE 1: INFRA PROVISIONING
# ===============================
  infra:
    name: Infra Provisioning (Terraform)
    runs-on: ubuntu-latest

    outputs:
      ec2_ip: ${{ steps.ip.outputs.EC2_IP }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::323001028681:role/saransh-oidc
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.3

      - name: Terraform Init
        working-directory: infra
        run: terraform init

      - name: Terraform Apply
        working-directory: infra
        run: terraform apply -auto-approve

      - name: Export EC2 Public IP
        id: ip
        working-directory: infra
        run: |
          echo "EC2_IP=$(terraform output -raw ec2_public_ip)" >> $GITHUB_OUTPUT

# ===============================
# STAGE 1.5: SONARQUBE SCAN
# ===============================
  sonarqube_scan:
    name: SonarQube Code Quality Scan
    runs-on: ubuntu-latest
    needs: infra

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=cn-web
            -Dsonar.projectName=CN-Web
            -Dsonar.sources=frontend
            -Dsonar.exclusions=**/node_modules/**,**/dist/**

# ===============================
# STAGE 2: BUILD + SCAN + PUSH
# ===============================
  build_push:
    name: Build, Scan & Push Image to ECR
    runs-on: ubuntu-latest
    needs: sonarqube_scan

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::323001028681:role/saransh-oidc
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker Image (Frontend)
        run: |
          docker build \
            -t $ECR_REPO:${IMAGE_TAG} \
            -f frontend/Dockerfile \
            frontend

      - name: Trivy Image Scan
        run: |
          mkdir -p trivy-reports
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v $(pwd)/trivy-reports:/reports \
            aquasec/trivy:latest \
            image \
            --severity HIGH,CRITICAL \
            --format json \
            --output /reports/trivy-image-report.json \
            $ECR_REPO:${IMAGE_TAG}

      - name: Upload Trivy Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: trivy-reports/trivy-image-report.json

      - name: Tag & Push Image to ECR
        run: |
          docker tag $ECR_REPO:${IMAGE_TAG} \
            $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:${IMAGE_TAG}

          docker push \
            $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:${IMAGE_TAG}

# ===============================
# STAGE 3: DEPLOY USING SSH
# ===============================
  deploy:
    name: Deploy on EC2 using SSH
    runs-on: ubuntu-latest
    needs: [infra, build_push]

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_SARANSH }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.infra.outputs.ec2_ip }} >> ~/.ssh/known_hosts

      - name: Deploy Docker Container on EC2
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ needs.infra.outputs.ec2_ip }} << EOF
          sudo apt-get update -y
          sudo apt-get install -y docker.io amazon-ecr-credential-helper

          sudo mkdir -p /root/.docker
          echo '{
            "credHelpers": {
              "323001028681.dkr.ecr.us-east-1.amazonaws.com": "ecr-login"
            }
          }' | sudo tee /root/.docker/config.json > /dev/null

          sudo systemctl restart docker

          sudo docker pull 323001028681.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_TAG}

          sudo docker rm -f cn-web-container || true

          sudo docker run -d \
            --name cn-web-container \
            -p 5173:5173 \
            323001028681.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_TAG}
          EOF
