name: CN-Web Deployment Pipeline (Infra + ECR + Deploy + Trivy)

# on:
#   push:
#     branches:
#       - feature/saransh
on:
  workflow_dispatch:  # manual trigger

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 323001028681
  ECR_REPO: cn-web
  IMAGE_TAG: ${{ github.sha }}

jobs:
# ===============================
# STAGE 1: INFRA PROVISIONING
# ===============================
  infra:
    name: Infra Provisioning (Terraform)
    runs-on: ubuntu-latest

    outputs:
      ec2_ip: ${{ steps.ip.outputs.EC2_IP }}

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::323001028681:role/saransh-oidc
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.3

      - name: Terraform Init
        working-directory: infra
        run: terraform init

      - name: Terraform Apply
        working-directory: infra
        run: terraform apply -auto-approve

      - name: Export EC2 Public IP
        id: ip
        working-directory: infra
        run: |
          echo "EC2_IP=$(terraform output -raw ec2_public_ip)" >> $GITHUB_OUTPUT

# ===============================
# STAGE 2: BUILD + SCAN + PUSH
# ===============================
  build_push:
    name: Build, Scan & Push Image to ECR
    runs-on: ubuntu-latest
    needs: infra

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::323001028681:role/saransh-oidc
          aws-region: ${{ env.AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker Image
        run: docker build -t $ECR_REPO:${IMAGE_TAG} .

      - name: Trivy Image Scan
        run: |
          mkdir -p trivy-reports
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v $(pwd)/trivy-reports:/reports \
            aquasec/trivy:latest \
            image \
            --severity HIGH,CRITICAL \
            --format json \
            --output /reports/trivy-image-report.json \
            $ECR_REPO:${IMAGE_TAG}

      - uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: trivy-reports/trivy-image-report.json

      - name: Tag & Push Image
        run: |
          docker tag $ECR_REPO:${IMAGE_TAG} \
            $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:${IMAGE_TAG}

          docker push \
            $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:${IMAGE_TAG}

# ===============================
# STAGE 3: DEPLOY USING SSH
# ===============================
  deploy:
    name: Deploy on EC2 using SSH
    runs-on: ubuntu-latest
    needs: [infra, build_push]

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_SARANSH }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.infra.outputs.ec2_ip }} >> ~/.ssh/known_hosts

      - name: Deploy Docker Container on EC2
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ needs.infra.outputs.ec2_ip }} << 'EOF'
            sudo apt-get update -y
            sudo apt-get install -y docker.io amazon-ecr-credential-helper

            mkdir -p ~/.docker
            cat << 'CONFIG' > ~/.docker/config.json
            {
              "credsStore": "ecr-login"
            }
            CONFIG

            sudo docker pull ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_TAG}

            sudo docker rm -f cn-web-container || true

            sudo docker run -d \
              --name cn-web-container \
              -p 4173:4173 \
              ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_TAG}
          EOF

